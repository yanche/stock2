
import * as config from 'config';
import * as bb from 'bluebird';
import * as co from 'co';
import * as db from '../db';

function genTodayScheduleTs(h: number, m: number): number {
    var d = new Date();
    d.setUTCHours(h);
    d.setUTCMinutes(m);
    d.setUTCSeconds(0);
    d.setUTCMilliseconds(0);
    return d.getTime();
}

function tsWeekend(ts: number) {
    var x = new Date(ts).getUTCDay();
    return x == 0 || x == 6;
}

const systId = 'scheduledtasks';
const systId_lhb = 'lhblastrefresh';
export default function jobScheduleCheck() {
    var lastOpTs: number = null;
    function loop() {
        const sts = genTodayScheduleTs(config.jobScheduleTime.h, config.jobScheduleTime.m), nowts = new Date().getTime();
        if (nowts >= sts && (lastOpTs == null || lastOpTs < sts) && !tsWeekend(sts)) {
            co(function* (): any {
                const systrack = yield db.systrack.getOne({ _id: systId }, { lastScheduleTs: 1 });
                const systLHB = yield db.systrack.getOne({ _id: systId_lhb }, { lastTs: 1, lastScheduleTs: 1 });
                if(systrack == null || systrack.lastScheduleTs<sts) {
                    try {
                        const objid = 
                    }
                }
            });
        }
    }
}
