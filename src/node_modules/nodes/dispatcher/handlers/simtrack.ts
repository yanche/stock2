
import * as utility from 'utility';
import * as bb from 'bluebird';
import * as db from '../db';
import * as hutil from './util';

export function handler(h: utility.http.HttpPack) {
    return bb.resolve().then(() => {
        const verb = (h.getReqHeader('verb') || '').toUpperCase();
        const fn = handlermap.get(verb);
        if (fn == null) return bb.reject(new Error(`simtrack handler not found for verb: ${verb}`));
        else return fn(h);
    });
}

// function getOrCreateHandler(hpack: utility.http.HttpPack): bb<void> {
//     return bb.resolve().then(() => {
//         const filter = hpack.reqbody.filter;
//         if (!utility.validate.isStr(filter.target) || !utility.validate.nonEmptyStr(filter.target) || !utility.validate.isStr(filter.rtplanId) || !utility.validate.nonEmptyStr(filter.rtplanId))
//             hpack.status = 400;
//         else return db.simtrack.findAndModify({ target: filter.target, rtplanId: filter.rtplanId }, { $unset: { ___rand: true } }, null, true, true)
//             .then(doc => {
//                 hpack.body = doc;
//             })
//     });
// }

const handlermap = new Map<string, (h: utility.http.HttpPack) => bb<void>>();
// handlermap.set('GETORCREATE', getOrCreateHandler);
handlermap.set('UPDATE', hutil.genUpdateAllHandler(db.simtrack, false));
