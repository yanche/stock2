
import * as bb from 'bluebird';

export default class Hub<T>{
    private _fn: () => PromiseLike<T>;
    private _resolved: boolean;
    private _result: T;
    private _pendingQ: Array<{ res: (thenableOrResult?: T | bb.Thenable<T>) => void, rej: (err?: any) => void }>;
    private _timeout: number;
    private _resolvedTs: number;

    constructor(fn: () => PromiseLike<T>, timeout?: number) {
        this._fn = fn;
        this._timeout = timeout;
    }

    get(): PromiseLike<T> {
        if (this._resolved && !this.timeout()) return bb.resolve(this._result);
        else {
            return new bb<T>((res, rej) => {
                this._pendingQ.push({ res: res, rej: rej });
                if (this._pendingQ.length === 1) {
                    this._resolved = false;
                    this._resolvedTs = null;
                    this._result = null;
                    process.nextTick(() => {
                        this._fn()
                            .then(val => {
                                this._resolved = true;
                                this._resolvedTs = new Date().getTime();
                                this._result = val;
                                for (let x of this._pendingQ) x.res(val);
                                this._pendingQ = [];
                            }, err => {
                                for (let x of this._pendingQ) x.rej(err);
                                this._pendingQ = [];
                            })
                    });
                }
            });
        }
    }
    timeout(): boolean {
        return this._timeout != null && this._resolvedTs != null && (this._timeout + this._resolvedTs <= new Date().getTime());
    }
}
